version: "3.9"

services:
  oracle-db:
    image: gvenzl/oracle-xe:21-slim
    container_name: onecore-oracle
    ports:
      - "1521:1521"
    environment:
      - ORACLE_PASSWORD=oracle
      - APP_USER=onecore
      - APP_USER_PASSWORD=onecore
    volumes:
      - oracle-data:/opt/oracle/oradata
    # DB가 완전히 뜰 때까지 대기하는 체크 로직
    healthcheck:
      test: ["CMD-SHELL", "exit | sqlplus -L SYS/oracle@localhost:1521/FREE AS SYSDBA"]
      interval: 10s
      timeout: 5s
      retries: 15

  onecore-app:
    build: .
    container_name: onecore-app
    ports:
      - "8080:8080"
    depends_on:
      oracle-db:
        condition: service_healthy
    environment:
      - SPRING_DATASOURCE_URL=jdbc:oracle:thin:@oracle-db:1521/FREE
      - SPRING_DATASOURCE_USERNAME=onecore
      - SPRING_DATASOURCE_PASSWORD=onecore
      - SPRING_JPA_HIBERNATE_DDL_AUTO=update

volumes:
  oracle-data: